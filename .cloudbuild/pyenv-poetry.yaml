steps: 
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker buildx create --name=container --driver=docker-container --use
        docker buildx build -f ../dockerfiles/Dockerfile.pyenv-poetry \
        -t drxc/python:${_PYTHONVERSION}-ubuntu${_BASE_VERSION}-${_DEVICE} \
        --builder=container \
        --platform=linux/amd64,linux/arm64 \
        --build-arg PYTHONVERSION=${_PYTHONVERSION} \
        --build-arg BASE_VERSION=${_BASE_VERSION} \
        --build-arg DEVICE=${_DEVICE} \
        --build-arg CUDA_VERSION=${_CUDA_VERSION} \
        --cache-to "type=registry,ref=drxc/python:${_PYTHONVERSION}-ubuntu${_BASE_VERSION}-${_DEVICE}-cache,mode=max" \
        --cache-from "type=registry,ref=drxc/python:${_PYTHONVERSION}-ubuntu${_BASE_VERSION}-${_DEVICE}-cache" \
        --push .
logsBucket: ${_LOG_BUCKET}